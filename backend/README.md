[![Tests](../../actions/workflows/tests-14-sprint.yml/badge.svg)](../../actions/workflows/tests-14-sprint.yml)


# Проект Mesto бэкенд + фронтенд

[Ссылка на GitHub репозиторий](https://github.com/chepash/express-mesto-gha)

Это проект является подготовительной частью будущего бэкенда, фронтенд для которого уже почти реализован. Пример работы фронтенда можно посмотреть на [GitHub Pages](https://chepash.github.io/react-mesto-auth/)


## Директории

- `/routes` — папка с файлами роутера  
- `/controllers` — папка с файлами контроллеров пользователя и карточки
- `/middlewares` — папка с модулем проверки авторизации пользователя
- `/models` — папка с файлами описания схем пользователя и карточки  
- `/errors` — папка с файлами кастомных классов ошибок
- `/utils` — папка с файлами используемых констант в проекте, функций валидации и обработки ошибок


## Запуск проекта

- `npm run start` — запускает сервер [localhost:3000](http://localhost:3000/)
- `npm run dev` — запускает сервер [localhost:3000](http://localhost:3000/) с `hot reload`;
- `npm run lint` — при запуске команды выполняется проверка проекта, в результате работы которой показываются ошибки линтинга
- `npm run lint-fix` — при запуске команды выполняется проверка проекта, в результате работы которой eslint попытается найти все ошибки и автоматически их исправить согласно своим настройкам


## Работа приложения:

- При успешном ответе сервера возвращается `json` ;
- При разных запросах сервер не падает и в консоли нет ошибок;
- При запуске приложение подключается к серверу `mongo` по адресу: `mongodb://127.0.0.1:27017/mestodb`;
- В приложении описана схема пользователя с полями:
  - `name` — строка от 2 до 30 символов, стандартное значение: `Жак-Ив Кусто`;
  - `about` — строка от 2 до 30 символов, стандартное значение: `Исследователь`;
  - `avatar` — строка, стандартное значение: `https://pictures.s3.yandex.net/resources/jacques-cousteau_1604399756.png`;
  - `email` — строка, уникальное поле, обязательное поле;
  - `password` — строка, обязательное поле.
- В приложении описана схема карточки с полями:
  - `name` — строка от 2 до 30 символов, обязательное поле;
  - `link` — строка, обязательное поле;
  - `owner` — `ObjectId`, обязательное поле;
  - `likes` — массив `ObjectId`, по умолчанию пустой;
  - `createdAt` — дата создания, по умолчанию `Date.now`;

- Все поля схем пользователя и карточки валидируются;
- В файлах схем создаются и экспортируются модели с именами `user` и `card` ;
- При обновлении пользователя или карточек в `options` передаётся `new: true` ;
- Ответ сервера на запрос отправляется только один раз;
- Поле `password` не ограничено в длину, так как пароль хранится в виде хеша.
- В контроллере `createUser` почта и хеш пароля записываются в базу;
- Создание пользователя в контроллере производится вызовом метода `create` модели, без дополнительной проверки на существование пользователя, так как поле `email` в схеме отмечено как уникальное;
- Поля `name`,  `about`  и  `avatar` пользователя необязательные. Если они не заполнены в запросе, то в них подставляются стандартные значения;
- Есть контроллер `login` , который проверяет полученные в теле запроса почту и пароль;
- Если почта и пароль верные, контроллер `login` создаёт `JWT`, в `payload` которого записано свойство `_id` с идентификатором пользователя.
- `JWT-токен` выпускается на определённый срок (7 дней), а не даётся бессрочно.
- В ответ на успешную авторизацию контроллер `login` возвращает клиенту созданный токен через заголовок `Set-Cookie`;
- Есть файл `middlewares/auth.js` , в нём `middleware` авторизации для проверки `JWT`.
- Роуты `/signin` и `/signup` не обрабатываются `middleware` авторизации.
- При правильном `JWT` авторизационный `middleware` добавляет в объект запроса `payload` токена и пропускает запрос дальше;
- Пользователь не может удалить карточку, которую он не создавал.


## Валидация данных:

- Поле `email` пользователя валидируется на соответствие паттерну почты, используются пакеты `validator` и `celebrate`;
- Тела запросов и, где необходимо, параметры запроса и заголовки валидируются по определённым схемам с помощью `celebrate`;
- Если запрос не соответствует схеме, обработка не должна передаётся контроллеру, клиент получает ошибку валидации;
- В контроллере отсутсвует валидации данных, если она описана с помощью `celebrate`;
- Поля `avatar` и `link` проверяются регулярным выражением.


## Приложение корректно обрабатывает запросы по следующим роутам:

- `POST /signin` — создаёт `JWT` и возвращает его в куки;
- `GET /signout` — чистит куки клиента;
- `POST /signup` — создаёт пользователя с переданными в теле запроса данными: 
  - `email`(обязательно), 
  - `password`(обязательно), 
  - `name`(опционально), 
  - `about`(опционально), 
  - `avatar`(опционально);

- `GET /users` — возвращает всех пользователей из базы;
- `PATCH /users/me` — обновляет профиль пользователя;
- `PATCH /users/me/avatar` — обновляет аватар пользователя;
- `GET /users/:userId` — возвращает пользователя по `_id` ;

- `GET /cards` — возвращает все карточки из базы;
- `POST /cards` — создаёт карточку с переданными в теле запроса `name` и `link` , устанавливает поле `owner` для карточки;
- `DELETE /cards/:cardId` — удаляет карточку по `_id`;
- `PUT /cards/:cardId/likes` — ставит лайк карточке;
- `DELETE /cards/:cardId/likes` — убирает лайк с карточки.


## Обработка ошибок в приложении:

- Если в любом из запросов что-то идёт не так, сервер возвращает ответ с ошибкой и соответствующим ей статусом:
  - `400` — переданы некорректные данные в методы создания карточки, пользователя, обновления аватара пользователя или профиля;
  - `401` — передан неверный логин или пароль. Также эту ошибку возвращает авторизационный middleware, если передан неверный JWT;
  - `403` — попытка удалить чужую карточку;
  - `404` — карточка или пользователь не найден или был запрошен несуществующий роут;
  - `409` — при регистрации указан email, который уже существует на сервере;
  - `500` — ошибка по умолчанию. Сопровождается сообщением: «На сервере произошла ошибка».

- Статусы ошибок вынесены в константы;
- Для всех, перечисленных выше, ошибок созданы классы конструкторы ошибок, наследуемые от `Error`;
- Не дублируются классы конструкторы ошибок с одинаковым статус-кодом;
- Во всех контроллерах предусмотрена гарантированная отправка сообщения об ошибке;
- Реализована централизованная обработка ошибок в единой `middleware`. Все ошибки проходят через централизованный обработчик `appErrorHandler`;
- Ошибки валидация входных данных отлавливаются встроенным в `celebrate` обработчиком ошибок `celebrate.error()`;
- При обработке ошибок в блоке `catch` они не выбрасываются через `throw` , а передаются в централизованный обработчик ошибок с помощью `next`.


## Дополнительные нюансы

- При написании кода проекта использовался `eslint` :
- Настройки `eslint` расширяют конфигурацию `airbnb-base`.

